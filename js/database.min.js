window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction;window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;var tv={};tv.page=1;tv.indexedDB={};var DB="tv_man";var DB_show="tv_shows";var DB_epi="tv_episodes";var DB_img="tv_images";tv.indexedDB.db=null;tv.indexedDB.open=function(){var e=2;var t=indexedDB.open(DB,e);t.onupgradeneeded=function(e){var t=e.target.result;e.target.transaction.onerror=tv.indexedDB.onerror;if(t.objectStoreNames.contains(DB)){t.deleteObjectStore(DB)}var n=t.createObjectStore(DB_show,{keyPath:"showid"});n.createIndex("name","name",{unique:false});n.createIndex("day","day",{unique:false});n.createIndex("deleted","deleted",{unique:false});var r=t.createObjectStore(DB_epi,{keyPath:"episodeID"});r.createIndex("showid","showid",{unique:false});r.createIndex("airdate","airdate",{unique:false});r.createIndex("season","season",{unique:false});r.createIndex("episode","episode",{unique:false});var i=t.createObjectStore(DB_img,{keyPath:"showid"})};t.onsuccess=function(e){tv.indexedDB.db=e.target.result;if(tv.page==1){tv.indexedDB.getAllShows()}else if(tv.page==2){tv.indexedDB.getTodayCount()}else if(tv.page==3){tv.indexedDB.getUpcoming()}};t.onerror=tv.indexedDB.onerror};tv.indexedDB.addShow=function(e){var t=tv.indexedDB.db;var n=t.transaction([DB_show],"readwrite");var r=n.objectStore(DB_show);var i=r.add(e);i.onsuccess=function(t){bootbox.alert("Show added. Downloading Episode list.",function(){tv.network.getEpisodes(e.showid)})};i.onerror=function(e){$("#loadingBar").hide();bootbox.alert("Error");console.log(e)}};tv.indexedDB.getAllShows=function(){var e=tv.indexedDB.db;var t=e.transaction([DB_show],"readwrite");var n=t.objectStore(DB_show);var r=n.count();r.onsuccess=function(e){if(r.result){var t=IDBKeyRange.lowerBound(0);var i=n.openCursor(t);i.onsuccess=function(e){var t=e.target.result;if(!!t==false)return;tv.ui.renderShows(t.value);tv.indexedDB.getPoster(t.value.showid);t.continue()};i.onerror=function(e){bootbox.alert("Error.");console.log(e)}}else{tv.ui.renderShows(0)}};r.onerror=function(e){bootbox.alert("Error.");console.log(e)}};tv.indexedDB.addEpisodes=function(e,t){var n=tv.indexedDB.db;var r=n.transaction([DB_epi],"readwrite");var i=r.objectStore(DB_epi);var s=0;for(var o=0;o<e.length;o++){var u=i.add(e[o]);u.onsuccess=function(n){s++;if(s==e.length){bootbox.alert("Episodes added. Downloading poster.",function(){tv.network.getPoster(t)})}};u.onerror=function(e){console.log(e)}}};tv.indexedDB.getEpisodes=function(e){var t=tv.indexedDB.db;var n=t.transaction([DB_epi],"readwrite");var r=n.objectStore(DB_epi);var i=IDBKeyRange.lowerBound(0);var s=r.openCursor(i);s.onsuccess=function(e){var t=e.target.result;if(!!t==false)return;tv.ui.renderShows(t.value);t.continue()};s.onerror=function(e){console.log(e)}};tv.indexedDB.deleteShow=function(e){var t=tv.indexedDB.db;var n=t.transaction([DB_show],"readwrite");var r=n.objectStore(DB_show);var i=r.delete(e.toString());i.onsuccess=function(t){tv.ui.renderHome();tv.indexedDB.deleteShowImg(e.toString())};i.onerror=function(e){console.log(e)}};tv.indexedDB.deleteShowImg=function(e){var t=tv.indexedDB.db;var n=t.transaction([DB_img],"readwrite");var r=n.objectStore(DB_img);var i=r.delete(e);i.onsuccess=function(t){bootbox.alert("Show deleted.",function(){tv.indexedDB.deleteShowEpisodes(e)})};i.onerror=function(e){console.log(e)}};tv.indexedDB.deleteShowEpisodes=function(e){var t=tv.indexedDB.db;var n=t.transaction([DB_epi],"readwrite");var r=n.objectStore(DB_epi);var i=r.index("showid");var s=new IDBKeyRange.only(e);var o=i.openCursor(s);o.onsuccess=function(e){var t=e.target.result;if(t){t.delete();t.continue()}};o.onerror=function(){bootbox.alert("Error opening DB.")}};tv.indexedDB.savePoster=function(e){var t=tv.indexedDB.db;var n=t.transaction([DB_img],"readwrite");var r=n.objectStore(DB_img);var i=r.add(e);i.onsuccess=function(e){bootbox.hideAll();bootbox.alert("Poster Saved.")};i.onerror=function(e){bootbox.alert("Error saving poster.");console.log(e)}};tv.indexedDB.getPoster=function(e){var t=tv.indexedDB.db;var n=t.transaction([DB_img],"readwrite");var r=n.objectStore(DB_img);var i=r.get(e);i.onsuccess=function(e){tv.ui.renderImg(i.result)}};tv.indexedDB.getToday=function(){var e=tv.indexedDB.db;var t=e.transaction([DB_epi],"readwrite");var n=t.objectStore(DB_epi);var r=tv.ui.getDate();var i=n.index("airdate");var s=IDBKeyRange.only(r);var o=i.openCursor(s);o.onsuccess=function(e){var t=e.target.result;if(t){tv.ui.renderPopup(t.value);console.log(t.value);t.continue()}}};tv.indexedDB.getTodayCount=function(){var e=tv.indexedDB.db;var t=e.transaction([DB_epi],"readwrite");var n=t.objectStore(DB_epi);var r=tv.ui.getDate();var i=n.index("airdate");var s=IDBKeyRange.only(r);var o=i.count(s);o.onsuccess=function(e){var t=e.target.result;var n=t.toString();if(t==0){tv.ui.renderPopup(0)}else{tv.indexedDB.getToday()}}};tv.indexedDB.getUpcoming=function(){var e=tv.indexedDB.db;var t=e.transaction([DB_epi],"readwrite");var n=t.objectStore(DB_epi);var r=tv.ui.getDate(-1);var i=tv.ui.getDate(3);var s=n.index("airdate");var o=IDBKeyRange.bound(r,i,false,false);var u=s.openCursor(o);u.onsuccess=function(e){var t=e.target.result;if(t){tv.ui.renderUpcoming(t.value);t.continue()}};u.onerror=function(){bootbox.alert("Error opening DB.")}};tv.indexedDB.updateEpisode=function(e){var t=tv.indexedDB.db;var n=t.transaction([DB_epi],"readwrite");var r=n.objectStore(DB_epi);var i=IDBKeyRange.only(e.episodeID);var s=r.openCursor(i);s.onsuccess=function(t){var n=t.target.result;var r=n.update(e);r.onsuccess=function(){bootbox.alert("Episode updated.")};r.onerror=function(){bootbox.alert("Error updating episode.")}};s.onerror=function(){bootbox.alert("Data not found.")}}